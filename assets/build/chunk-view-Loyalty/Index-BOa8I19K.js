import{f as m,g as _e,i as ye,c as y,o as d,d as l,b as n,p as a,u as e,Z,h as ve,s as P,a as W,x as f,P as _,C as u,t as s,_ as F,$ as b,a0 as U,a2 as fe,a3 as ge,a1 as B,a4 as he,F as L,k as z,Y as be,n as q,a6 as Ce,a7 as J,a8 as K,a9 as X,aa as ee}from"../chunk-vendor-vue-CVODRAc9.js";import{u as we,a as T}from"../chunk-component-NotificationsBell-BlaTfaiw.js";import{a as ke}from"../chunk-view-Bookings/BookingAppearance-Vn9NL_13.js";import{P as xe}from"../chunk-component-PageHeader-DIMefZ9l.js";import{S as A}from"../chunk-component-StatCard-CUh-yMQt.js";import{_ as Ve,C as te}from"../chunk-component-Card-DAbGoLxt.js";import{E as Se}from"../chunk-component-EmptyState-B8o9iOHP.js";import{L as Te}from"../chunk-component-LoadingSpinner-DYzABkFM.js";import"../chunk-vendor-6xaPOP3o.js";import"../chunk-vendor-charts-C66rl4lP.js";import"../chunk-vendor-pinia-DSPKUyr1.js";import"../chunk-vendor-axios-B9ygI19o.js";import"../chunk-component-Sidebar-ChD_VDDH.js";import"../chunk-view-Bookings/BookingFormPreview-CiRU9DIL.js";const Me={class:"loyalty-page"},Ie={class:"stats-grid"},Pe={value:""},We={value:"earned"},Ae={value:"redeemed"},Ee={value:"adjustment"},je={value:"expired"},Ne={key:2,class:"table-wrapper"},Re={class:"table-header-row"},De={class:"th-date"},Fe={class:"th-customer"},Ue={class:"th-type"},Be={class:"th-points"},Le={class:"th-desc"},ze={class:"td-id"},$e={class:"tx-id-badge"},Ge={class:"td-date"},He={class:"td-customer"},Oe={class:"customer-cell"},Qe={class:"customer-name"},Ye=["href"],Ze={class:"td-type"},qe={class:"td-points"},Je={class:"td-desc"},Ke={class:"transaction-description"},Xe={key:0,class:"d-flex justify-content-between align-items-center"},et={class:"text-muted"},tt={value:""},lt=["value"],at={class:"alert alert-info"},ot={value:""},st=["value"],rt={__name:"Index",setup(nt){const{t}=we(),v=ke(),le=ve(),M=m([]),C=m({}),E=m(!1),j=m(!1),x=m(!1),I=m([]),N=m(!1),V=m(!1),$=m(null),g=m({customer_id:""}),p=m({customer_id:"",points:1,description:""}),w=m({type:"",customer_search:""}),i=m({current_page:1,per_page:20,total:0,total_pages:0}),ae=c=>c?new Date(c).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"-",oe=c=>({earned:t("loyalty.earned"),redeemed:t("loyalty.redeemed"),adjustment:t("loyalty.adjustment"),expired:t("loyalty.expired")})[c]||c,se=c=>({earned:"cil-plus",redeemed:"cil-minus",adjustment:"cil-pen",expired:"cil-x-circle"})[c]||"cil-info",k=async()=>{var c;E.value=!0;try{const r={page:i.value.current_page,per_page:i.value.per_page,...w.value};Object.keys(r).forEach(S=>{r[S]===""&&delete r[S]});const o=await T.get("/loyalty/transactions",{params:r,noCache:!0}),h=((c=o.data)==null?void 0:c.data)||o.data||{};M.value=h.items||[],i.value=h.pagination||i.value}catch(r){console.error("Error loading transactions:",r),v.error(t("common.errorLoading")),M.value=[],i.value={current_page:1,per_page:20,total:0,total_pages:0}}finally{E.value=!1}},G=async()=>{var c;try{const r=await T.get("/loyalty/stats",{noCache:!0});C.value=((c=r.data)==null?void 0:c.data)||{}}catch(r){console.error("Error loading stats:",r),C.value={}}},H=async()=>{var c;try{const r=await T.get("/customers",{params:{per_page:200},noCache:!0}),o=((c=r.data)==null?void 0:c.data)||r.data||{};I.value=o.items||o||[]}catch{I.value=[]}},O=_e(()=>I.value||[]),re=c=>{i.value.current_page=c,k()};let Q;const ne=()=>{clearTimeout(Q),Q=setTimeout(()=>{i.value.current_page=1,k()},500)},ce=()=>{w.value={type:"",customer_search:""},i.value.current_page=1,k()},Y=()=>{j.value=!0,p.value={customer_id:"",points:1,description:""}},R=()=>{j.value=!1,x.value=!1},ie=async()=>{if(!p.value.customer_id){v.error(t("loyalty.selectCustomer")||"Select customer");return}if(Number(p.value.points||0)<=0){v.error(t("loyalty.invalidPoints")||"Invalid points");return}x.value=!0;try{await T.post("/loyalty/redeem",{customer_id:Number(p.value.customer_id),points:Number(p.value.points||0),reference_type:"manual",reference_id:null,description:p.value.description||""}),v.success(t("loyalty.redeemedSuccess")||"Redeemed successfully"),R(),await Promise.all([G(),k()])}catch(c){console.error("Redeem points error:",c),v.error(t("loyalty.redeemError")||t("common.errorLoading"))}finally{x.value=!1}},ue=()=>{le.push("/programs/settings")},de=()=>{N.value=!0,g.value={customer_id:$.value||""},I.value.length===0&&H()},D=()=>{N.value=!1,V.value=!1,g.value={customer_id:""}},me=async()=>{var c,r,o;if(!g.value.customer_id){v.error(t("loyalty.selectCustomer")||"Select customer");return}V.value=!0;try{const h=await T.post(`/apple-wallet/create/${g.value.customer_id}/loyalty`),S=((c=h.data)==null?void 0:c.data)||h.data||{};S.pass_url?(window.open(S.pass_url,"_blank"),v.success(t("loyalty.passCreated")||"تم إنشاء البطاقة بنجاح")):v.error(t("loyalty.passError")||"حدث خطأ في إنشاء البطاقة"),D()}catch(h){console.error("Error creating Apple Wallet pass:",h),v.error(((o=(r=h.response)==null?void 0:r.data)==null?void 0:o.message)||t("loyalty.passError")||"حدث خطأ في إنشاء البطاقة")}finally{V.value=!1}},pe=c=>{const r=String(c||"");return r==="earned"?"badge-earned":r==="redeemed"?"badge-redeemed":r==="adjustment"?"badge-adjustment":"badge-expired"};return ye(()=>{k(),G(),H()}),(c,r)=>(d(),y("div",Me,[l(xe,{title:e(t)("loyalty.title"),subtitle:e(t)("loyalty.subtitle")||e(t)("loyalty.title")+" - "+e(t)("dashboard.subtitle")},{icon:a(()=>[l(e(u),{icon:"cil-gift"})]),actions:a(()=>[l(e(f),{color:"secondary",variant:"outline",class:"me-2 settings-btn",onClick:ue},{default:a(()=>[l(e(u),{icon:"cil-settings",class:"me-2"}),_(" "+s(e(t)("nav.programsSettings")),1)]),_:1}),$.value?(d(),P(e(f),{key:0,color:"success",variant:"outline",class:"me-2 apple-wallet-btn",onClick:de},{default:a(()=>[l(e(u),{icon:"cil-wallet",class:"me-2"}),_(" "+s(e(t)("loyalty.addToAppleWallet")||"أضف إلى Apple Wallet"),1)]),_:1})):W("",!0),l(e(f),{color:"primary",class:"btn-primary-custom",onClick:Y},{default:a(()=>[l(e(u),{icon:"cil-gift",class:"me-2"}),_(" "+s(e(t)("loyalty.redeem")),1)]),_:1})]),_:1},8,["title","subtitle"]),n("div",Ie,[l(A,{label:e(t)("loyalty.totalIssued"),value:C.value.total_points_issued||0,"badge-variant":"info",color:"gold"},{icon:a(()=>[l(e(u),{icon:"cil-star"})]),_:1},8,["label","value"]),l(A,{label:e(t)("loyalty.totalRedeemed"),value:C.value.total_points_redeemed||0,"badge-variant":"warning",color:"gold"},{icon:a(()=>[l(e(u),{icon:"cil-gift"})]),_:1},8,["label","value"]),l(A,{label:e(t)("loyalty.points"),value:C.value.active_points||0,"badge-variant":"success",color:"gold"},{icon:a(()=>[l(e(u),{icon:"cil-check-circle"})]),_:1},8,["label","value"]),l(A,{label:e(t)("loyalty.activeCustomers"),value:C.value.active_customers||0,"badge-variant":"info",color:"gold"},{icon:a(()=>[l(e(u),{icon:"cil-user"})]),_:1},8,["label","value"])]),l(te,{title:e(t)("common.filter"),icon:"cil-filter",class:"filters-card"},{default:a(()=>[l(e(F),{class:"g-3"},{default:a(()=>[l(e(b),{md:4},{default:a(()=>[l(e(U),{modelValue:w.value.type,"onUpdate:modelValue":r[0]||(r[0]=o=>w.value.type=o),label:e(t)("common.status"),onChange:k},{default:a(()=>[n("option",Pe,s(e(t)("common.all")||"All"),1),n("option",We,s(e(t)("loyalty.earned")),1),n("option",Ae,s(e(t)("loyalty.redeemed")),1),n("option",Ee,s(e(t)("loyalty.adjustment")),1),n("option",je,s(e(t)("loyalty.expired")),1)]),_:1},8,["modelValue","label"])]),_:1}),l(e(b),{md:6},{default:a(()=>[l(e(fe),{class:"search-input-group"},{default:a(()=>[l(e(ge),{class:"search-icon-wrapper"},{default:a(()=>[l(e(u),{icon:"cil-magnifying-glass"})]),_:1}),l(e(B),{modelValue:w.value.customer_search,"onUpdate:modelValue":r[1]||(r[1]=o=>w.value.customer_search=o),placeholder:e(t)("loyalty.searchCustomer"),onInput:ne,class:"filter-input search-input"},null,8,["modelValue","placeholder"])]),_:1})]),_:1}),l(e(b),{md:2},{default:a(()=>[l(e(f),{color:"secondary",variant:"outline",onClick:ce,class:"w-100 reset-btn"},{default:a(()=>[l(e(u),{icon:"cil-reload",class:"me-1"}),_(" "+s(e(t)("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["title"]),l(te,{title:e(t)("loyalty.title"),icon:"cil-list"},{footer:a(()=>[i.value.total_pages>1?(d(),y("div",Xe,[n("div",et,s(e(t)("common.view"))+" "+s((i.value.current_page-1)*i.value.per_page+1)+" "+s(e(t)("common.to"))+" "+s(Math.min(i.value.current_page*i.value.per_page,i.value.total))+" "+s(e(t)("common.of"))+" "+s(i.value.total),1),l(e(Ce),{pages:i.value.total_pages,"active-page":i.value.current_page,"onUpdate:activePage":re},null,8,["pages","active-page"])])):W("",!0)]),default:a(()=>[E.value?(d(),P(Te,{key:0,text:e(t)("common.loading")},null,8,["text"])):M.value.length===0?(d(),P(Se,{key:1,title:e(t)("common.noData"),description:e(t)("loyalty.noTransactions")||e(t)("loyalty.title")+" - "+e(t)("common.noData"),"icon-color":"gray"},{action:a(()=>[l(e(f),{color:"primary",class:"btn-primary-custom",onClick:Y},{default:a(()=>[_(s(e(t)("loyalty.redeem")),1)]),_:1})]),_:1},8,["title","description"])):(d(),y("div",Ne,[l(e(he),{hover:"",responsive:"",class:"table-modern loyalty-table"},{default:a(()=>[n("thead",null,[n("tr",Re,[r[6]||(r[6]=n("th",{class:"th-id"},"#",-1)),n("th",De,s(e(t)("common.date")),1),n("th",Fe,s(e(t)("loyalty.customer")),1),n("th",Ue,s(e(t)("loyalty.type")||"Type"),1),n("th",Be,s(e(t)("loyalty.points")),1),n("th",Le,s(e(t)("loyalty.description")||"Description"),1)])]),n("tbody",null,[(d(!0),y(L,null,z(M.value,o=>(d(),y("tr",{key:o.id,class:"table-row loyalty-row"},[n("td",ze,[n("span",$e,"#"+s(o.id),1)]),n("td",Ge,s(ae(o.created_at)),1),n("td",He,[n("div",Oe,[n("strong",Qe,s(o.customer_name||"—"),1),o.customer_phone?(d(),y("a",{key:0,class:"customer-phone",href:`tel:${o.customer_phone}`},s(o.customer_phone),9,Ye)):W("",!0)])]),n("td",Ze,[l(e(be),{class:q(["unified-badge",pe(o.type)])},{default:a(()=>[l(e(u),{icon:se(o.type),class:"badge-icon"},null,8,["icon"]),n("span",null,s(oe(o.type)),1)]),_:2},1032,["class"])]),n("td",qe,[n("strong",{class:q(["points-amount",Number(o.points)>=0?"points-plus":"points-minus"])},s(Number(o.points)>=0?"+":"")+s(o.points),3)]),n("td",Je,[n("span",Ke,s(o.description||"—"),1)])]))),128))])]),_:1})]))]),_:1},8,["title"]),l(e(Z),{visible:N.value,onClose:D,size:"lg"},{default:a(()=>[l(e(J),null,{default:a(()=>[l(e(K),null,{default:a(()=>[l(e(u),{icon:"cil-wallet",class:"me-2"}),_(" "+s(e(t)("loyalty.addToAppleWallet")||"أضف إلى Apple Wallet"),1)]),_:1})]),_:1}),l(e(X),null,{default:a(()=>[l(e(F),{class:"g-3"},{default:a(()=>[l(e(b),{md:12},{default:a(()=>[l(e(U),{modelValue:g.value.customer_id,"onUpdate:modelValue":r[2]||(r[2]=o=>g.value.customer_id=o),label:e(t)("loyalty.selectCustomer")||"Select Customer",class:"filter-select"},{default:a(()=>[n("option",tt,s(e(t)("common.select")),1),(d(!0),y(L,null,z(O.value,o=>(d(),y("option",{key:o.id,value:String(o.id)},s(o.name)+" ("+s(o.phone||o.email)+") ",9,lt))),128))]),_:1},8,["modelValue","label"])]),_:1}),g.value.customer_id?(d(),P(e(b),{key:0,md:12},{default:a(()=>[n("div",at,[l(e(u),{icon:"cil-info",class:"me-2"}),_(" "+s(e(t)("loyalty.appleWalletInfo")||"سيتم إنشاء بطاقة Apple Wallet تحتوي على نقاط الولاء والعضوية و QR Code لسكان النقاط"),1)])]),_:1})):W("",!0)]),_:1})]),_:1}),l(e(ee),null,{default:a(()=>[l(e(f),{color:"secondary",onClick:D},{default:a(()=>[_(s(e(t)("common.cancel")),1)]),_:1}),l(e(f),{color:"success",class:"btn-primary-custom",disabled:V.value||!g.value.customer_id,onClick:me},{default:a(()=>[l(e(u),{icon:"cil-wallet",class:"me-2"}),_(" "+s(V.value?e(t)("common.loading")||"Loading...":e(t)("loyalty.createPass")||"إنشاء البطاقة"),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(Z),{visible:j.value,onClose:R,size:"lg"},{default:a(()=>[l(e(J),null,{default:a(()=>[l(e(K),null,{default:a(()=>[l(e(u),{icon:"cil-gift",class:"me-2"}),_(" "+s(e(t)("loyalty.redeem")),1)]),_:1})]),_:1}),l(e(X),null,{default:a(()=>[l(e(F),{class:"g-3"},{default:a(()=>[l(e(b),{md:6},{default:a(()=>[l(e(U),{modelValue:p.value.customer_id,"onUpdate:modelValue":r[3]||(r[3]=o=>p.value.customer_id=o),label:e(t)("loyalty.customer"),class:"filter-select"},{default:a(()=>[n("option",ot,s(e(t)("common.select")),1),(d(!0),y(L,null,z(O.value,o=>(d(),y("option",{key:o.id,value:String(o.id)},s(o.name)+" ("+s(o.phone)+") ",9,st))),128))]),_:1},8,["modelValue","label"])]),_:1}),l(e(b),{md:6},{default:a(()=>[l(e(B),{modelValue:p.value.points,"onUpdate:modelValue":r[4]||(r[4]=o=>p.value.points=o),modelModifiers:{number:!0},type:"number",min:"1",step:"1",label:e(t)("loyalty.points"),class:"filter-input"},null,8,["modelValue","label"])]),_:1}),l(e(b),{md:12},{default:a(()=>[l(e(B),{modelValue:p.value.description,"onUpdate:modelValue":r[5]||(r[5]=o=>p.value.description=o),label:e(t)("loyalty.description")||"Description",class:"filter-input"},null,8,["modelValue","label"])]),_:1})]),_:1})]),_:1}),l(e(ee),null,{default:a(()=>[l(e(f),{color:"secondary",onClick:R},{default:a(()=>[_(s(e(t)("common.cancel")),1)]),_:1}),l(e(f),{color:"primary",class:"btn-primary-custom",disabled:x.value,onClick:ie},{default:a(()=>[l(e(u),{icon:"cil-check",class:"me-2"}),_(" "+s(x.value?e(t)("loyalty.processing")||e(t)("common.loading"):e(t)("loyalty.redeem")),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["visible"])]))}},wt=Ve(rt,[["__scopeId","data-v-99fe92f1"]]);export{wt as default};
