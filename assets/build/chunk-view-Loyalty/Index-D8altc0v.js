import{f as m,g as ve,i as fe,c as v,o as d,d as a,b as r,p as o,u as e,Z as q,h as ge,s as W,a as A,x as h,P as _,C as u,t as s,_ as U,$ as w,a0 as B,a2 as he,a3 as be,a1 as L,a4 as Ce,F as z,k as $,Y as we,n as J,a6 as ke,a7 as K,a8 as X,a9 as ee,aa as te}from"../chunk-vendor-vue-9XB69CcG.js";import{u as xe,a as M}from"../chunk-component-NotificationsBell-Dr2jTnD2.js";import{u as Ve}from"../chunk-view-AppleWallet/Simulator-CvFDWpvU.js";import{P as Se}from"../chunk-component-PageHeader-DOCn2Cgp.js";import{S as E}from"../chunk-component-StatCard-COK6V2Ia.js";import{_ as Te,C as ae}from"../chunk-component-Card-CPZTx4Dn.js";import{E as Me}from"../chunk-component-EmptyState-EtsdDTwC.js";import{L as Ie}from"../chunk-component-LoadingSpinner-CoUPkIjP.js";import"../chunk-vendor-6xaPOP3o.js";import"../chunk-vendor-charts-C66rl4lP.js";import"../chunk-vendor-pinia-BpPt1UDF.js";import"../chunk-vendor-axios-B9ygI19o.js";const Pe={class:"loyalty-page"},We={class:"stats-grid"},Ae={value:""},Ee={value:"earned"},je={value:"redeemed"},Ne={value:"adjustment"},De={value:"expired"},Fe={key:2,class:"table-wrapper"},Re={class:"table-header-row"},Ue={class:"th-date"},Be={class:"th-customer"},Le={class:"th-type"},ze={class:"th-points"},$e={class:"th-desc"},Ge={class:"td-id"},He={class:"tx-id-badge"},Oe={class:"td-date"},Qe={class:"td-customer"},Ye={class:"customer-cell"},Ze={class:"customer-name"},qe=["href"],Je={class:"td-type"},Ke={class:"td-points"},Xe={class:"td-desc"},et={class:"transaction-description"},tt={key:0,class:"d-flex justify-content-between align-items-center"},at={class:"text-muted"},lt={value:""},ot=["value"],st={class:"alert alert-info"},nt={value:""},rt=["value"],ct={__name:"Index",setup(it){const{t}=xe(),f=Ve(),le=ge(),I=m([]),k=m({}),j=m(!1),N=m(!1),S=m(!1),P=m([]),D=m(!1),T=m(!1),G=m(null),b=m({customer_id:""}),p=m({customer_id:"",points:1,description:""}),x=m({type:"",customer_search:""}),i=m({current_page:1,per_page:20,total:0,total_pages:0}),oe=c=>c?new Date(c).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"-",se=c=>({earned:t("loyalty.earned"),redeemed:t("loyalty.redeemed"),adjustment:t("loyalty.adjustment"),expired:t("loyalty.expired")})[c]||c,ne=c=>({earned:"cil-plus",redeemed:"cil-minus",adjustment:"cil-pen",expired:"cil-x-circle"})[c]||"cil-info",V=async()=>{var c;j.value=!0;try{const n={page:i.value.current_page,per_page:i.value.per_page,...x.value};Object.keys(n).forEach(C=>{n[C]===""&&delete n[C]});const l=await M.get("/loyalty/transactions",{params:n,noCache:!0}),y=((c=l.data)==null?void 0:c.data)||l.data||{};I.value=y.items||[],i.value=y.pagination||i.value}catch(n){console.error("Error loading transactions:",n),f.error(t("common.errorLoading")),I.value=[],i.value={current_page:1,per_page:20,total:0,total_pages:0}}finally{j.value=!1}},H=async()=>{var c;try{const n=await M.get("/loyalty/stats",{noCache:!0});k.value=((c=n.data)==null?void 0:c.data)||{}}catch(n){console.error("Error loading stats:",n),k.value={}}},O=async()=>{var c;try{const n=await M.get("/customers",{params:{per_page:200},noCache:!0}),l=((c=n.data)==null?void 0:c.data)||n.data||{};P.value=l.items||l||[]}catch{P.value=[]}},Q=ve(()=>P.value||[]),re=c=>{i.value.current_page=c,V()};let Y;const ce=()=>{clearTimeout(Y),Y=setTimeout(()=>{i.value.current_page=1,V()},500)},ie=()=>{x.value={type:"",customer_search:""},i.value.current_page=1,V()},Z=()=>{N.value=!0,p.value={customer_id:"",points:1,description:""}},F=()=>{N.value=!1,S.value=!1},ue=async()=>{var c,n,l,y,C;if(!p.value.customer_id){f.error(t("loyalty.selectCustomer")||"Select customer");return}if(Number(p.value.points||0)<=0){f.error(t("loyalty.invalidPoints")||"Invalid points");return}S.value=!0;try{await M.post("/loyalty/redeem",{customer_id:Number(p.value.customer_id),points:Number(p.value.points||0),reference_type:"manual",reference_id:null,description:p.value.description||""}),f.success(t("loyalty.redeemedSuccess")||"Redeemed successfully"),F(),await Promise.all([H(),V()])}catch(g){const ye=((n=(c=g==null?void 0:g.response)==null?void 0:c.data)==null?void 0:n.message)||((C=(y=(l=g==null?void 0:g.response)==null?void 0:l.data)==null?void 0:y.data)==null?void 0:C.message)||(g==null?void 0:g.message)||t("loyalty.redeemError")||t("common.errorLoading");f.error(ye)}finally{S.value=!1}},de=()=>{le.push("/programs/settings")},me=()=>{D.value=!0,b.value={customer_id:G.value||""},P.value.length===0&&O()},R=()=>{D.value=!1,T.value=!1,b.value={customer_id:""}},pe=async()=>{var c,n,l;if(!b.value.customer_id){f.error(t("loyalty.selectCustomer")||"Select customer");return}T.value=!0;try{const y=await M.post(`/apple-wallet/create/${b.value.customer_id}/loyalty`),C=((c=y.data)==null?void 0:c.data)||y.data||{};C.pass_url?(window.open(C.pass_url,"_blank"),f.success(t("loyalty.passCreated")||"تم إنشاء البطاقة بنجاح")):f.error(t("loyalty.passError")||"حدث خطأ في إنشاء البطاقة"),R()}catch(y){console.error("Error creating Apple Wallet pass:",y),f.error(((l=(n=y.response)==null?void 0:n.data)==null?void 0:l.message)||t("loyalty.passError")||"حدث خطأ في إنشاء البطاقة")}finally{T.value=!1}},_e=c=>{const n=String(c||"");return n==="earned"?"badge-earned":n==="redeemed"?"badge-redeemed":n==="adjustment"?"badge-adjustment":"badge-expired"};return fe(()=>{V(),H(),O()}),(c,n)=>(d(),v("div",Pe,[a(Se,{title:e(t)("loyalty.title"),subtitle:e(t)("loyalty.subtitle")||e(t)("loyalty.title")+" - "+e(t)("dashboard.subtitle")},{icon:o(()=>[a(e(u),{icon:"cil-gift"})]),actions:o(()=>[a(e(h),{color:"secondary",variant:"outline",class:"me-2 settings-btn",onClick:de},{default:o(()=>[a(e(u),{icon:"cil-settings",class:"me-2"}),_(" "+s(e(t)("nav.programsSettings")),1)]),_:1}),G.value?(d(),W(e(h),{key:0,color:"success",variant:"outline",class:"me-2 apple-wallet-btn",onClick:me},{default:o(()=>[a(e(u),{icon:"cil-wallet",class:"me-2"}),_(" "+s(e(t)("loyalty.addToAppleWallet")||"أضف إلى Apple Wallet"),1)]),_:1})):A("",!0),a(e(h),{color:"primary",class:"btn-primary-custom",onClick:Z},{default:o(()=>[a(e(u),{icon:"cil-gift",class:"me-2"}),_(" "+s(e(t)("loyalty.redeem")),1)]),_:1})]),_:1},8,["title","subtitle"]),r("div",We,[a(E,{label:e(t)("loyalty.totalIssued"),value:k.value.total_points_issued||0,"badge-variant":"info",color:"gold"},{icon:o(()=>[a(e(u),{icon:"cil-star"})]),_:1},8,["label","value"]),a(E,{label:e(t)("loyalty.totalRedeemed"),value:k.value.total_points_redeemed||0,"badge-variant":"warning",color:"gold"},{icon:o(()=>[a(e(u),{icon:"cil-gift"})]),_:1},8,["label","value"]),a(E,{label:e(t)("loyalty.points"),value:k.value.active_points||0,"badge-variant":"success",color:"gold"},{icon:o(()=>[a(e(u),{icon:"cil-check-circle"})]),_:1},8,["label","value"]),a(E,{label:e(t)("loyalty.activeCustomers"),value:k.value.active_customers||0,"badge-variant":"info",color:"gold"},{icon:o(()=>[a(e(u),{icon:"cil-user"})]),_:1},8,["label","value"])]),a(ae,{title:e(t)("common.filter"),icon:"cil-filter",class:"filters-card"},{default:o(()=>[a(e(U),{class:"g-3"},{default:o(()=>[a(e(w),{md:4},{default:o(()=>[a(e(B),{modelValue:x.value.type,"onUpdate:modelValue":n[0]||(n[0]=l=>x.value.type=l),label:e(t)("common.status"),onChange:V},{default:o(()=>[r("option",Ae,s(e(t)("common.all")||"All"),1),r("option",Ee,s(e(t)("loyalty.earned")),1),r("option",je,s(e(t)("loyalty.redeemed")),1),r("option",Ne,s(e(t)("loyalty.adjustment")),1),r("option",De,s(e(t)("loyalty.expired")),1)]),_:1},8,["modelValue","label"])]),_:1}),a(e(w),{md:6},{default:o(()=>[a(e(he),{class:"search-input-group"},{default:o(()=>[a(e(be),{class:"search-icon-wrapper"},{default:o(()=>[a(e(u),{icon:"cil-magnifying-glass"})]),_:1}),a(e(L),{modelValue:x.value.customer_search,"onUpdate:modelValue":n[1]||(n[1]=l=>x.value.customer_search=l),placeholder:e(t)("loyalty.searchCustomer"),onInput:ce,class:"filter-input search-input"},null,8,["modelValue","placeholder"])]),_:1})]),_:1}),a(e(w),{md:2},{default:o(()=>[a(e(h),{color:"secondary",variant:"outline",onClick:ie,class:"w-100 reset-btn"},{default:o(()=>[a(e(u),{icon:"cil-reload",class:"me-1"}),_(" "+s(e(t)("common.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["title"]),a(ae,{title:e(t)("loyalty.title"),icon:"cil-list"},{footer:o(()=>[i.value.total_pages>1?(d(),v("div",tt,[r("div",at,s(e(t)("common.view"))+" "+s((i.value.current_page-1)*i.value.per_page+1)+" "+s(e(t)("common.to"))+" "+s(Math.min(i.value.current_page*i.value.per_page,i.value.total))+" "+s(e(t)("common.of"))+" "+s(i.value.total),1),a(e(ke),{pages:i.value.total_pages,"active-page":i.value.current_page,"onUpdate:activePage":re},null,8,["pages","active-page"])])):A("",!0)]),default:o(()=>[j.value?(d(),W(Ie,{key:0,text:e(t)("common.loading")},null,8,["text"])):I.value.length===0?(d(),W(Me,{key:1,title:e(t)("common.noData"),description:e(t)("loyalty.noTransactions")||e(t)("loyalty.title")+" - "+e(t)("common.noData"),"icon-color":"gray"},{action:o(()=>[a(e(h),{color:"primary",class:"btn-primary-custom",onClick:Z},{default:o(()=>[_(s(e(t)("loyalty.redeem")),1)]),_:1})]),_:1},8,["title","description"])):(d(),v("div",Fe,[a(e(Ce),{hover:"",responsive:"",class:"table-modern loyalty-table"},{default:o(()=>[r("thead",null,[r("tr",Re,[n[6]||(n[6]=r("th",{class:"th-id"},"#",-1)),r("th",Ue,s(e(t)("common.date")),1),r("th",Be,s(e(t)("loyalty.customer")),1),r("th",Le,s(e(t)("loyalty.type")||"Type"),1),r("th",ze,s(e(t)("loyalty.points")),1),r("th",$e,s(e(t)("loyalty.description")||"Description"),1)])]),r("tbody",null,[(d(!0),v(z,null,$(I.value,l=>(d(),v("tr",{key:l.id,class:"table-row loyalty-row"},[r("td",Ge,[r("span",He,"#"+s(l.id),1)]),r("td",Oe,s(oe(l.created_at)),1),r("td",Qe,[r("div",Ye,[r("strong",Ze,s(l.customer_name||"—"),1),l.customer_phone?(d(),v("a",{key:0,class:"customer-phone",href:`tel:${l.customer_phone}`},s(l.customer_phone),9,qe)):A("",!0)])]),r("td",Je,[a(e(we),{class:J(["unified-badge",_e(l.type)])},{default:o(()=>[a(e(u),{icon:ne(l.type),class:"badge-icon"},null,8,["icon"]),r("span",null,s(se(l.type)),1)]),_:2},1032,["class"])]),r("td",Ke,[r("strong",{class:J(["points-amount",Number(l.points)>=0?"points-plus":"points-minus"])},s(Number(l.points)>=0?"+":"")+s(l.points),3)]),r("td",Xe,[r("span",et,s(l.description||"—"),1)])]))),128))])]),_:1})]))]),_:1},8,["title"]),a(e(q),{visible:D.value,onClose:R,size:"lg"},{default:o(()=>[a(e(K),null,{default:o(()=>[a(e(X),null,{default:o(()=>[a(e(u),{icon:"cil-wallet",class:"me-2"}),_(" "+s(e(t)("loyalty.addToAppleWallet")||"أضف إلى Apple Wallet"),1)]),_:1})]),_:1}),a(e(ee),null,{default:o(()=>[a(e(U),{class:"g-3"},{default:o(()=>[a(e(w),{md:12},{default:o(()=>[a(e(B),{modelValue:b.value.customer_id,"onUpdate:modelValue":n[2]||(n[2]=l=>b.value.customer_id=l),label:e(t)("loyalty.selectCustomer")||"Select Customer",class:"filter-select"},{default:o(()=>[r("option",lt,s(e(t)("common.select")),1),(d(!0),v(z,null,$(Q.value,l=>(d(),v("option",{key:l.id,value:String(l.id)},s(l.name)+" ("+s(l.phone||l.email)+") ",9,ot))),128))]),_:1},8,["modelValue","label"])]),_:1}),b.value.customer_id?(d(),W(e(w),{key:0,md:12},{default:o(()=>[r("div",st,[a(e(u),{icon:"cil-info",class:"me-2"}),_(" "+s(e(t)("loyalty.appleWalletInfo")||"سيتم إنشاء بطاقة Apple Wallet تحتوي على نقاط الولاء والعضوية و QR Code لسكان النقاط"),1)])]),_:1})):A("",!0)]),_:1})]),_:1}),a(e(te),null,{default:o(()=>[a(e(h),{color:"secondary",onClick:R},{default:o(()=>[_(s(e(t)("common.cancel")),1)]),_:1}),a(e(h),{color:"success",class:"btn-primary-custom",disabled:T.value||!b.value.customer_id,onClick:pe},{default:o(()=>[a(e(u),{icon:"cil-wallet",class:"me-2"}),_(" "+s(T.value?e(t)("common.loading")||"Loading...":e(t)("loyalty.createPass")||"إنشاء البطاقة"),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(e(q),{visible:N.value,onClose:F,size:"lg"},{default:o(()=>[a(e(K),null,{default:o(()=>[a(e(X),null,{default:o(()=>[a(e(u),{icon:"cil-gift",class:"me-2"}),_(" "+s(e(t)("loyalty.redeem")),1)]),_:1})]),_:1}),a(e(ee),null,{default:o(()=>[a(e(U),{class:"g-3"},{default:o(()=>[a(e(w),{md:6},{default:o(()=>[a(e(B),{modelValue:p.value.customer_id,"onUpdate:modelValue":n[3]||(n[3]=l=>p.value.customer_id=l),label:e(t)("loyalty.customer"),class:"filter-select"},{default:o(()=>[r("option",nt,s(e(t)("common.select")),1),(d(!0),v(z,null,$(Q.value,l=>(d(),v("option",{key:l.id,value:String(l.id)},s(l.name)+" ("+s(l.phone)+") ",9,rt))),128))]),_:1},8,["modelValue","label"])]),_:1}),a(e(w),{md:6},{default:o(()=>[a(e(L),{modelValue:p.value.points,"onUpdate:modelValue":n[4]||(n[4]=l=>p.value.points=l),modelModifiers:{number:!0},type:"number",min:"1",step:"1",label:e(t)("loyalty.points"),class:"filter-input"},null,8,["modelValue","label"])]),_:1}),a(e(w),{md:12},{default:o(()=>[a(e(L),{modelValue:p.value.description,"onUpdate:modelValue":n[5]||(n[5]=l=>p.value.description=l),label:e(t)("loyalty.description")||"Description",class:"filter-input"},null,8,["modelValue","label"])]),_:1})]),_:1})]),_:1}),a(e(te),null,{default:o(()=>[a(e(h),{color:"secondary",onClick:F},{default:o(()=>[_(s(e(t)("common.cancel")),1)]),_:1}),a(e(h),{color:"primary",class:"btn-primary-custom",disabled:S.value,onClick:ue},{default:o(()=>[a(e(u),{icon:"cil-check",class:"me-2"}),_(" "+s(S.value?e(t)("loyalty.processing")||e(t)("common.loading"):e(t)("loyalty.redeem")),1)]),_:1},8,["disabled"])]),_:1})]),_:1},8,["visible"])]))}},wt=Te(ct,[["__scopeId","data-v-b1699240"]]);export{wt as default};
